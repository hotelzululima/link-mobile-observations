---
#- name: Have the necessary SSH key
#  hosts: localhost
#  tasks:
#    - name: copy the ssh key
#      copy:
#        content: '{{ pda_manager_key }}'
#        dest: /tmp/swarm_manager_id_rsa
#        mode: 0600
- name: Upload and run updated docker images in swarm stack
  hosts: manager
#  hosts: localhost
  tasks:
    - name: Log into Docker Hub
      docker_login:
        username: '{{ docker_user }}'
        password: '{{ docker_password }}'
        email: '{{ docker_email }}'
    - name: copy docker-compose file to manager
      template:
        src: 'files/docker-compose-stack.yml.j2'
        dest: ~/docker-compose.yml
    - name: run docker-compose stack
      shell: "docker stack deploy -c docker-compose.yml observations --with-registry-auth --prune"
    - name: Log out of Docker Hub
      docker_login:
        state: absent
#- name: Tell Datadog about the deployment
#  hosts: localhost
#  tasks:
#    - datadog_event:
#        title: PDA deployment in {{ env }}
#        text: Build {{ lookup('env', 'BUILDKITE_BUILD_NUMBER') }} ({{ version_tag }})
#        api_key: '{{ dd_api_key }}'
#        app_key: '{{ dd_app_key }}'